from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
import time

# ===== CONFIG =====
TARGET_URL = "your_datasight_link"
DOWNLOAD_DIR = r"C:\Users\45k9071\Downloads\datasight"
CHROMEDRIVER_PATH = r"C:\Users\45k9071\Documents\Selenium\SeleniumDrivers\chromedriver.exe"

# ===== SETUP CHROME =====
chrome_options = Options()
chrome_options.add_argument("--start-maximized")

# anti-detection (same as your script)
chrome_options.add_experimental_option("excludeSwitches", ["enable-automation"])
chrome_options.add_experimental_option("useAutomationExtension", False)
chrome_options.add_argument("--disable-blink-features=AutomationControlled")

# your download prefs (to match your existing script)
prefs = {
    "download.default_directory": DOWNLOAD_DIR,
    "download.prompt_for_download": False,
    "download.directory_upgrade": True,
    "safebrowsing.enabled": True
}
chrome_options.add_experimental_option("prefs", prefs)

service = Service(CHROMEDRIVER_PATH)
driver = webdriver.Chrome(service=service, options=chrome_options)
wait = WebDriverWait(driver, 20)

# ===== OPEN DATASIGHT =====
print("\n‚úÖ Opening Datasight‚Ä¶")
driver.get(TARGET_URL)
time.sleep(2)

print("‚úÖ Please login manually in the Google popup")
print("üëâ Enter email")
print("üëâ Click NEXT")
print("üëâ Approve MFA/SSO if shown")
print("üëâ Wait for dashboard to load")
print("‚è≥ Script will watch until dashboard appears‚Ä¶\n")

# ===== WAIT FOR DASHBOARD =====
dashboard_loaded = False

DASHBOARD_MARKERS = [
    "SDLC", "GRAS", "APP Count", "Application Data", "L1", "L2", "L3"
]

# scan for up to 180 seconds (3 minutes)
for _ in range(180):
    try:
        for marker in DASHBOARD_MARKERS:
            if driver.find_elements(By.XPATH, f"//*[contains(text(),'{marker}')]"):
                dashboard_loaded = True
                break
        if dashboard_loaded:
            break
    except:
        pass

    time.sleep(1)

if dashboard_loaded:
    print("\n‚úÖ STEP 1 COMPLETE ‚Äî Dashboard loaded successfully!\n")
else:
    print("\n‚ö†Ô∏è Dashboard did not load in time, but browser is still open.\n")
