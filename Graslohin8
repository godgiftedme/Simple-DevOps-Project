Thank you ‚Äî this photo confirms the entire root cause.
Look carefully at your working code:

‚úÖ It never closes because it contains:

‚úÖ multiple nested try/except blocks

‚úÖ a FOR loop scanning 15 IFRAMES

‚úÖ a WHILE-loop-like behavior using increments

‚úÖ repeated sleep(4) calls

‚úÖ a final ‚ÄúScript will wait until dashboard appears‚Äù loop

‚úÖ complex logic that forces the script to stay alive


Your script is essentially doing this:

while dashboard not found:
    try clicking Google login
    try scanning the main page
    try scanning all iframes (15 times)
    sleep a few seconds

‚ñ∫ THAT IS WHY IT NEVER CLOSES.

That‚Äôs why your minimal script always closed: ‚úÖ your working script has a giant ‚Äúwait loop‚Äù
‚ùå our simple Step-1 did not

So the fix is simple:


---

‚úÖ ‚úÖ WE WILL NOT REPLACE STEP-1

‚úÖ We will extend your existing working script
‚úÖ Step-1 is already perfect
‚úÖ It loads dashboard successfully
‚úÖ We should only add Step-2, 3, 4 AFTER this block

Meaning:

üëâ Your current Step-1 ends here:

‚úÖ STEP COMPLETE - Dashboard loaded successfully
Script will wait until dashboard appears.

This is visible in your terminal.

‚úÖ That is the correct moment to jump into Step-2 (click GRAS-CHG level).

‚õî We do NOT rebuild Step-1

‚úÖ We attach Step-2 after your dashboard detection


---

‚úÖ ‚úÖ Based on the photo, Step-1 ends around these lines:

You have something like:

if dashboard_loaded:
    print("‚úÖ STEP COMPLETE - dashboard loaded successfully")
else:
    print("‚ö†Ô∏è Dashboard did not load")

Right after this area is where we insert Step-2.


---

‚úÖ ‚úÖ HERE IS EXACTLY WHAT YOU MUST PASTE AFTER STEP-1

üìå Paste this exactly after the line:

‚úÖ STEP COMPLETE - dashboard loaded successfully


---

‚úÖ ‚úÖ Step-2 Insert Code (Fully Compatible With Your Script)

# ============ STEP 2: CLICK "GRAS - CHG level" TAB ============

print("\n‚û°Ô∏è STEP 2: Clicking GRAS - CHG level...")

try:
    gras_tab = WebDriverWait(driver, 30).until(
        EC.element_to_be_clickable(
            (By.XPATH, "//*[normalize-space(text())='GRAS - CHG level']")
        )
    )
    driver.execute_script("arguments[0].scrollIntoView(true);", gras_tab)
    time.sleep(1)
    gras_tab.click()
    print("‚úÖ GRAS - CHG level clicked")
except Exception as e:
    print("‚ùå Could not click GRAS - CHG level:", e)
    # continue anyway
time.sleep(5)

‚úÖ This code is safe
‚úÖ No browser closing
‚úÖ Works with manual login
‚úÖ Uses the same driver and wait
‚úÖ Uses your same environment


---

‚úÖ ‚úÖ Step-3 ‚Äî reveal and open 3 dots

Paste right after Step-2 block:

# ============ STEP 3: OPEN THE 3-DOTS MENU ============

print("\n‚û°Ô∏è STEP 3: Looking for 3-dots menu...")

three_dots_xpaths = [
    "//button[@aria-label='More']",
    "//button[contains(@title,'More')]",
    "//button[.//span[contains(text(),'more')]]",
    "(//*[contains(text(),'‚ãÆ') or contains(text(),'‚Ä¶')])[1]"
]

opened = False
for xp in three_dots_xpaths:
    try:
        el = WebDriverWait(driver, 15).until(
            EC.element_to_be_clickable((By.XPATH, xp))
        )
        driver.execute_script("arguments[0].scrollIntoView(true);", el)
        time.sleep(0.5)
        el.click()
        opened = True
        print("‚úÖ 3-dots menu opened")
        break
    except:
        pass

if not opened:
    print("‚ùå Could not open 3 dots menu. Try adjusting the XPath.")


---

‚úÖ ‚úÖ Step-4 ‚Äî Export CSV (Excel)

# ============ STEP 4: EXPORT CSV (EXCEL) ============

print("\n‚û°Ô∏è STEP 4: Exporting data to CSV...")

try:
    export_option = WebDriverWait(driver, 20).until(
        EC.element_to_be_clickable(
            (By.XPATH, "//*[normalize-space()='Export data']")
        )
    )
    export_option.click()
    print("‚úÖ Export data clicked")
except:
    print("‚ùå Export data option not found")

time.sleep(2)

try:
    csv_radio = driver.find_element(By.XPATH, "//*[normalize-space()='CSV (Excel)']")
    csv_radio.click()
    print("‚úÖ CSV (Excel) selected")
except:
    print("‚ö†Ô∏è CSV (Excel) radio not found")

time.sleep(1)

try:
    export_btn = driver.find_element(By.XPATH, "//button[.//span[normalize-space()='Export']]")
    export_btn.click()
    print("‚úÖ Export button clicked")
except:
    print("‚ùå Could not click Export button")

print("\n‚úÖ CSV download should start now.")
time.sleep(10)


---

‚úÖ ‚úÖ WHAT TO DO NEXT

‚úÖ DO NOT change your Step-1
‚úÖ DO NOT rebuild login
‚úÖ ONLY paste Step-2, Step-3, Step-4 after the dashboard detection block
‚úÖ The browser will NOT close
‚úÖ Script will continue


---

‚úÖ FINAL CHECKLIST:

You should confirm:

‚úÖ Step-1 still loads dashboard manually
‚úÖ Step-2 clicks GRAS-CHG level
‚úÖ Step-3 opens 3 dots
‚úÖ Step-4 exports CSV


---

If ANY locator fails, send me a photo of:

‚úÖ The GRAS-CHG tab
‚úÖ The 3 dots button
‚úÖ The export popup

I will adjust the XPaths perfectly.


---

‚úÖ Go ahead. Paste Step-2, Step-3, Step-4 AFTER your Step-1.

Tell me: What happened?
